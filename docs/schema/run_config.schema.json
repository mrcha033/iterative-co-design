{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/icd/run_config.schema.json",
  "title": "ICD Run Config",
  "type": "object",
  "properties": {
    "pipeline": {
      "type": "object",
      "properties": {
        "mode": {"enum": ["linear", "iterative"]},
        "transform_stage": {
          "type": "string",
          "enum": [
            "auto",
            "default",
            "pre",
            "pre_w",
            "before",
            "before_w",
            "quant_first",
            "post",
            "post_perm",
            "after",
            "after_perm",
            "both",
            "pre_and_post"
          ]
        },
        "post_transform_repermute": {
          "type": "string",
          "enum": [
            "auto",
            "never",
            "off",
            "disabled",
            "always",
            "force",
            "delta",
            "delta_only"
          ]
        },
        "repermute_on_delta": {"type": "boolean"},
        "repeats": {"type": "integer", "minimum": 1},
        "warmup_iter": {"type": "integer", "minimum": 0},
        "fixed_clock": {"type": "boolean"},
        "no_measure": {"type": "boolean"},
        "reuse_perm": {"type": "string"},
        "runner": {"type": ["string", "object"]},
        "runner_context": {"type": "object"}
      },
      "required": ["mode"]
    },
    "graph": {
      "type": "object",
      "properties": {
        "source": {"enum": ["mock", "pytorch", "trace"]},
        "normalize": {"enum": ["sym", "row", "none"]},
        "mock": {
          "type": "object",
          "properties": {
            "d": {"type": "integer", "minimum": 2},
            "blocks": {"type": "integer", "minimum": 1},
            "noise": {"type": "number", "minimum": 0},
            "seed": {"type": "integer"}
          }
        },
        "trace": {"oneOf": [
          {"type": "string"},
          {"type": "array", "items": {"type": "array", "minItems": 3, "maxItems": 3}}
        ]},
        "loader": {"type": "string"},
        "loader_args": {"type": "array"},
        "loader_kwargs": {"type": "object"}
      },
      "required": ["source"]
    },
    "solver": {
      "type": "object",
      "properties": {
        "time_budget_s": {"type": "number", "exclusiveMinimum": 0},
        "refine_steps": {"type": "integer", "minimum": 0},
        "k_blocks": {"type": ["integer", "null"]},
        "rng_seed": {"type": "integer"}
      }
    },
    "transform": {"type": "object"},
    "measure": {
      "type": "object",
      "properties": {
        "ncu_enable": {"type": "boolean"},
        "power_enable": {"type": "boolean"},
        "power_sample_hz": {"type": "integer", "minimum": 1},
        "tvm_enable": {"type": "boolean"},
        "tvm_trials": {"type": "integer", "minimum": 0},
        "tvm_target": {"type": "string"},
        "tvm_use_ansor": {"type": "boolean"},
        "tvm_log": {"type": "string"},
        "tvm_artifacts_dir": {"type": "string"},
        "tvm_repeats": {"type": "integer", "minimum": 1},
        "tvm_warmup": {"type": "integer", "minimum": 0}
      }
    },
    "cache": {
      "type": "object",
      "properties": {
        "enable": {"type": "boolean"},
        "cache_dir": {"type": "string"}
      }
    },
    "report": {
      "type": "object",
      "properties": {
        "out_dir": {"type": "string"},
        "formats": {
          "type": "array",
          "items": {"enum": ["html", "csv"]}
        }
      },
      "required": ["out_dir"]
    }
  },
  "required": ["pipeline", "graph", "solver", "report"]
}
